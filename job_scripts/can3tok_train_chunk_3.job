#!/bin/bash
#SBATCH --job-name=can3tok_semantic
#SBATCH --partition=gpu_h100
#SBATCH --gpus=1
#SBATCH --time=12:00:00
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=9
#SBATCH --mem=64G
#SBATCH --output=logs/baseliner_val=train_cannorm_200e_3k_9.out
#SBATCH --error=logs/can3tok_%j.err

# ============================================================================
# CAN3TOK TRAINING - FULL SEMANTIC CONTROL + COLOR WEIGHTING
# ============================================================================
# This job file gives you complete control over semantic learning via flags
# No need to edit YAML files - everything controlled here!
# 
# NEW: Color loss weighting for balanced loss mode
# ============================================================================

echo "================================================================================"
echo "               CAN3TOK TRAINING - SEMANTIC LEARNING CONTROL"
echo "================================================================================"
echo "Job ID: $SLURM_JOB_ID"
echo "Node: $SLURM_NODELIST"
echo "Start time: $(date)"
echo ""

# ============================================================================
# ğŸ¯ SEMANTIC LEARNING CONFIGURATION - CHOOSE YOUR OPTION!
# ============================================================================

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  UNCOMMENT THE OPTION YOU WANT TO USE                                   â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# OPTION 1: NO SEMANTIC LEARNING (Baseline - Fastest, Least Memory)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SEMANTIC_MODE="geometric"
SEGMENT_WEIGHT=0.0
INSTANCE_WEIGHT=0.0

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# OPTION 2: GEOMETRIC MODE (Recommended - Best Balance!)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SEMANTIC_MODE="geometric"
# SEGMENT_WEIGHT=0.3
# INSTANCE_WEIGHT=0.0

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# OPTION 3: HIDDEN STATE MODE (Best Quality - Slowest)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SEMANTIC_MODE="hidden"
# SEGMENT_WEIGHT=0.3
# INSTANCE_WEIGHT=0.0

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# OPTION 4: ATTENTION MODE (Spatial Context)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SEMANTIC_MODE="attention"
# SEGMENT_WEIGHT=0.3
# INSTANCE_WEIGHT=0.0

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Semantic Loss Additional Parameters
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SEMANTIC_TEMP=0.1
SEMANTIC_SUBSAMPLE=10000
SAMPLING_STRATEGY="balanced"

# ============================================================================
# TRAINING HYPERPARAMETERS
# ============================================================================

BATCH_SIZE=64
NUM_EPOCHS=200
LEARNING_RATE=1e-4
KL_WEIGHT=1e-5                # â† Fixed: was 1e-4 (too strong)
# RECON_SCALE=1.0              # â† Fixed: was 1.0 (too dominant)
EVAL_EVERY=10
FAILURE_THRESHOLD=100

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ¨ Color Loss Weighting (NEW!)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Controls color emphasis in balanced loss mode
# Default: 1.0 (equal weight with other parameters)
# Higher values: Force model to learn colors better (try 2.0-5.0)
# Only active when USE_BALANCED_LOSS=True
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
COLOR_LOSS_WEIGHT=1.0

# Recommended values:
# 1.0 = Equal weight (default, balanced)
# 2.0 = Moderate color emphasis (good starting point)
# 3.0 = Strong color emphasis (recommended for gray collapse)
# 5.0 = Very strong color emphasis (aggressive color learning)

# ============================================================================
# DATASET CONFIGURATION
# ============================================================================

TRAIN_SCENES=500
VAL_SCENES=30
SAMPLING_METHOD="opacity"

# ============================================================================
# PCA VISUALIZATION CONFIGURATION (CloudCompare)
# ============================================================================

PCA_VIS_FREQ=10                # Generate PCA PLY files every N epochs
PCA_NUM_SCENES=5             # Number of scenes to visualize with PCA
PCA_BRIGHTNESS=1.25            # Color brightness for PCA visualization

# ============================================================================
# 3DGS RECONSTRUCTION CONFIGURATION (supersplat.at)
# ============================================================================

RECON_PLY_FREQ=5              # Save reconstructed 3DGS PLY every N epochs
RECON_PLY_NUM_SCENES=2        # Number of scenes to reconstruct
RECON_PLY_MAX_SH=3             # Max SH degree (f_rest terms = 0)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ¯ NORMALIZATION CONTROL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Dataset normalization (canonical sphere for positions & scales)
USE_CANONICAL_NORM=True     # True = normalize to [-10, 10], False = raw coordinates

# Loss function normalization (per-parameter balancing)
# USE_BALANCED_LOSS=True      # True = balanced loss, False = standard L2

echo "ğŸ¯ NORMALIZATION SETTINGS:"
echo "   Dataset (canonical sphere): $([ "$USE_CANONICAL_NORM" = "True" ] && echo "âœ… ENABLED" || echo "âŒ DISABLED")"
echo "   Loss (parameter balancing): $([ "$USE_BALANCED_LOSS" = "True" ] && echo "âœ… ENABLED" || echo "âŒ DISABLED")"
echo ""

# ============================================================================
# WEIGHTS & BIASES CONFIGURATION
# ============================================================================

export WANDB_API_KEY="your_key_here"
USE_WANDB=False

# ============================================================================
# PRINT CONFIGURATION SUMMARY
# ============================================================================

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "                        CONFIGURATION SUMMARY"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "ğŸ“‹ JOB INFORMATION:"
echo "   Job ID:            $SLURM_JOB_ID"
echo "   Partition:         $SLURM_JOB_PARTITION"
echo "   Node:              $SLURM_NODELIST"
echo "   GPUs:              $SLURM_GPUS"
echo "   CPUs:              $SLURM_CPUS_PER_TASK"
echo "   Memory:            64GB"
echo "   Time Limit:        12:00:00"
echo ""

echo "ğŸ§  SEMANTIC LEARNING:"

if (( $(echo "$SEGMENT_WEIGHT > 0" | bc -l) )) || (( $(echo "$INSTANCE_WEIGHT > 0" | bc -l) )); then
    echo "   Status:            âœ… ENABLED"
    echo "   Mode:              ${SEMANTIC_MODE^^}"
    echo ""
    echo "   Loss Weights:"
    echo "      Segment (Î²):    $SEGMENT_WEIGHT"
    echo "      Instance (Î³):   $INSTANCE_WEIGHT"
    echo "      Temperature:    $SEMANTIC_TEMP"
    echo "      Subsample:      $SEMANTIC_SUBSAMPLE Gaussians"
    echo ""
    
    echo ""
    echo "   Loss Composition:"
    echo "      Total = (Recon / $RECON_SCALE) + ($KL_WEIGHT Ã— KL) + Semantic"
    echo "      Semantic = ($SEGMENT_WEIGHT Ã— Segment) + ($INSTANCE_WEIGHT Ã— Instance)"

    # Approximate loss balance with raw semantic ~4.5
    echo ""
    echo "   Approx. Loss Balance (raw semantic ~4.5):"
    echo "      Recon:    235 / $RECON_SCALE â‰ˆ $(echo "scale=3; 235/$RECON_SCALE" | bc)"
    echo "      KL:       6000 Ã— $KL_WEIGHT  â‰ˆ $(echo "scale=3; 6000*$KL_WEIGHT" | bc)"
    echo "      Semantic: 4.5  Ã— $SEGMENT_WEIGHT  â‰ˆ $(echo "scale=3; 4.5*$SEGMENT_WEIGHT" | bc)"

else
    echo "   Status:            âŒ DISABLED (Baseline)"
    echo "   Loss Composition:"
    echo "      Total = (Recon / $RECON_SCALE) + ($KL_WEIGHT Ã— KL)"
fi

echo ""

echo "âš™ï¸  TRAINING HYPERPARAMETERS:"
echo "   Batch Size:        $BATCH_SIZE"
echo "   Epochs:            $NUM_EPOCHS"
echo "   Learning Rate:     $LEARNING_RATE"
echo "   KL Weight:         $KL_WEIGHT"
echo "   Recon Scale:       $RECON_SCALE"
echo "   Eval Every:        $EVAL_EVERY epochs"
echo "   Failure Thresh:    $FAILURE_THRESHOLD"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ¨ COLOR LOSS WEIGHTING (NEW!)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "ğŸ¨ COLOR LOSS CONFIGURATION:"
echo "   Color Loss Weight: $COLOR_LOSS_WEIGHT"
if [ "$USE_BALANCED_LOSS" = "True" ]; then
    echo "   Status:            âœ… ACTIVE (balanced loss enabled)"
    if (( $(echo "$COLOR_LOSS_WEIGHT > 1.0" | bc -l) )); then
        echo "   Effect:            ğŸ¯ Emphasizing color learning (${COLOR_LOSS_WEIGHT}Ã— weight)"
    else
        echo "   Effect:            âš–ï¸  Equal weight with other parameters"
    fi
else
    echo "   Status:            âŠ˜ INACTIVE (only active when balanced loss enabled)"
fi
echo ""
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "ğŸ“Š DATASET:"
echo "   Training Scenes:   $TRAIN_SCENES"
echo "   Val Scenes:        $VAL_SCENES"
echo "   Sampling:          ${SAMPLING_METHOD^^}"
echo "   Color Mode:        Normalized [0,1] (no /255 needed)"
echo ""

echo "ğŸ¨ PCA VISUALIZATION (CloudCompare):"
echo "   Frequency:         Every $PCA_VIS_FREQ epochs"
echo "   Scenes:            $PCA_NUM_SCENES per epoch"
echo "   Files/Epoch:       $((PCA_NUM_SCENES * 3)) PLY files (semantic + position + original)"
echo "   Total Files:       $((NUM_EPOCHS / PCA_VIS_FREQ * PCA_NUM_SCENES * 3)) PLY files"
echo "   Output:            checkpoints/.../pca_visualizations/epoch_XXX/"
echo ""

echo "ğŸŒ 3DGS RECONSTRUCTION (supersplat.at):"
echo "   Frequency:         Every $RECON_PLY_FREQ epochs"
echo "   Scenes:            $RECON_PLY_NUM_SCENES per epoch"
echo "   Max SH Degree:     $RECON_PLY_MAX_SH (f_rest = 0)"
echo "   Color Mode:        Clamped [0,1] â†’ f_dc via C0 (NO SIGMOID!)"
echo "   Scale Mode:        Log-space â†’ exp() activation (matches Can3Tok)"
echo "   Total PLY Files:   $((NUM_EPOCHS / RECON_PLY_FREQ * RECON_PLY_NUM_SCENES)) files"
echo "   Output:            checkpoints/.../reconstructed_gaussians/epoch_XXX/"
echo "   View At:           https://supersplat.at"
echo ""

echo "ğŸ“ˆ LOGGING:"
echo "   W&B:               $([ "$USE_WANDB" = "True" ] && echo "âœ… Enabled" || echo "âŒ Disabled")"
echo "   Checkpoints:       Every 10 epochs"
echo "   Best Model:        Tracked by val L2 error"
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ============================================================================
# ENVIRONMENT SETUP
# ============================================================================

echo "ğŸ”§ Setting up environment..."
module purge && module load 2023 && module load CUDA/12.1.1
export PATH="/home/yli11/.conda/envs/can3tok/bin:$PATH"
export LD_LIBRARY_PATH="/home/yli11/.conda/envs/can3tok/lib/python3.11/site-packages/torch/lib:$LD_LIBRARY_PATH"

cd /home/yli11/scratch/Hafeez_thesis/Can3Tok
mkdir -p logs checkpoints

echo "   âœ“ Modules loaded"
echo "   âœ“ Conda environment: can3tok"
echo "   âœ“ Working directory: $(pwd)"
echo ""

# W&B setup (fixed: removed colon after else)
if [ "$USE_WANDB" = "True" ]; then
    wandb login $WANDB_API_KEY --relogin 2>/dev/null
    echo "   âœ“ Weights & Biases authenticated"
else
    echo "   âŠ˜ Weights & Biases disabled"
fi
echo ""

# ============================================================================
# BUILD TRAINING COMMAND
# ============================================================================

echo "ğŸš€ Building training command..."

TRAIN_CMD="python gs_can3tok_2.py"

# â”€â”€â”€ Training parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TRAIN_CMD="$TRAIN_CMD --batch_size $BATCH_SIZE"
TRAIN_CMD="$TRAIN_CMD --num_epochs $NUM_EPOCHS"
TRAIN_CMD="$TRAIN_CMD --lr $LEARNING_RATE"
TRAIN_CMD="$TRAIN_CMD --kl_weight $KL_WEIGHT"
TRAIN_CMD="$TRAIN_CMD --eval_every $EVAL_EVERY"
TRAIN_CMD="$TRAIN_CMD --failure_threshold $FAILURE_THRESHOLD"
# TRAIN_CMD="$TRAIN_CMD --recon_scale $RECON_SCALE"

# â”€â”€â”€ Dataset parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TRAIN_CMD="$TRAIN_CMD --train_scenes $TRAIN_SCENES"
TRAIN_CMD="$TRAIN_CMD --val_scenes $VAL_SCENES"
TRAIN_CMD="$TRAIN_CMD --sampling_method $SAMPLING_METHOD"

# â”€â”€â”€ Semantic parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TRAIN_CMD="$TRAIN_CMD --semantic_mode $SEMANTIC_MODE"
TRAIN_CMD="$TRAIN_CMD --segment_loss_weight $SEGMENT_WEIGHT"
TRAIN_CMD="$TRAIN_CMD --instance_loss_weight $INSTANCE_WEIGHT"
TRAIN_CMD="$TRAIN_CMD --semantic_temperature $SEMANTIC_TEMP"
TRAIN_CMD="$TRAIN_CMD --semantic_subsample $SEMANTIC_SUBSAMPLE"
TRAIN_CMD="$TRAIN_CMD --sampling_strategy $SAMPLING_STRATEGY"

# â”€â”€â”€ Color loss weighting (NEW!) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TRAIN_CMD="$TRAIN_CMD --color_loss_weight $COLOR_LOSS_WEIGHT"

# â”€â”€â”€ PCA visualization parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TRAIN_CMD="$TRAIN_CMD --pca_vis_freq $PCA_VIS_FREQ"
TRAIN_CMD="$TRAIN_CMD --pca_num_scenes $PCA_NUM_SCENES"
TRAIN_CMD="$TRAIN_CMD --pca_brightness $PCA_BRIGHTNESS"

# â”€â”€â”€ 3DGS reconstruction parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TRAIN_CMD="$TRAIN_CMD --recon_ply_freq $RECON_PLY_FREQ"
TRAIN_CMD="$TRAIN_CMD --recon_ply_num_scenes $RECON_PLY_NUM_SCENES"
TRAIN_CMD="$TRAIN_CMD --recon_ply_max_sh $RECON_PLY_MAX_SH"

# â”€â”€â”€ Normalization flags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# if [ "$USE_BALANCED_LOSS" = "True" ]; then
#     TRAIN_CMD="$TRAIN_CMD --use_balanced_loss"
# fi

if [ "$USE_CANONICAL_NORM" = "False" ]; then
    TRAIN_CMD="$TRAIN_CMD --no_canonical_norm"
fi

# â”€â”€â”€ W&B â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ "$USE_WANDB" = "True" ]; then
    TRAIN_CMD="$TRAIN_CMD --use_wandb"
    TRAIN_CMD="$TRAIN_CMD --wandb_project Can3Tok-Semantic"
    TRAIN_CMD="$TRAIN_CMD --wandb_entity 3D-SSC"
fi

echo "   Command:"
echo "   $TRAIN_CMD"
echo ""

# ============================================================================
# START TRAINING
# ============================================================================

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "                          STARTING TRAINING"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

SECONDS=0

eval $TRAIN_CMD
TRAIN_EXIT=$?

DURATION=$((SECONDS / 60))

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "                          TRAINING COMPLETE"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Exit code:     $TRAIN_EXIT"
echo "Duration:      $DURATION minutes"
echo "End time:      $(date)"
echo ""

if [ $TRAIN_EXIT -eq 0 ]; then
    echo "âœ… Training completed successfully!"
    echo ""
    echo "Next steps:"
    echo "   1. Check logs:                cat logs/can3tok_${SLURM_JOB_ID}.out"
    echo "   2. Find checkpoints:          ls checkpoints/RGB_job_${SLURM_JOB_ID}_*/"
    echo "   3. Load best model:           checkpoints/RGB_job_${SLURM_JOB_ID}_*/best_model.pth"
    echo ""
    echo "   PCA Visualizations (CloudCompare):"
    echo "      Location:   checkpoints/RGB_job_${SLURM_JOB_ID}_*/pca_visualizations/"
    echo "      Open:       epoch_090/scene_000_semantic_pca.ply"
    echo ""
    echo "   3DGS Reconstructions (supersplat.at):"
    echo "      Location:   checkpoints/RGB_job_${SLURM_JOB_ID}_*/reconstructed_gaussians/"
    echo "      Open:       epoch_090/scene_000_epoch_090.ply"
    echo "      Drag & drop to: https://supersplat.at"
    if [ "$USE_WANDB" = "True" ]; then
        echo ""
        echo "   W&B Dashboard: https://wandb.ai/3D-SSC/Can3Tok-Semantic"
    fi
else
    echo "âŒ Training failed with exit code $TRAIN_EXIT"
    echo ""
    echo "Troubleshooting:"
    echo "   1. Check error log:      cat logs/can3tok_${SLURM_JOB_ID}.err"
    echo "   2. Check GPU memory:     nvidia-smi"
    echo "   3. Verify dataset:       ls /home/yli11/scratch/datasets/gaussian_world/preprocessed/interior_gs/"
fi

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"